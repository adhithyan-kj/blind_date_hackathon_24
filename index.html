<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitaFlow - Advanced AI Blood Donation Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- EmailJS for Notifications -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <!-- Custom Styles and Animations -->
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOutDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        #ai-chat-container { animation-duration: 0.4s; animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        .chat-slide-in { animation-name: slideInUp; }
        .chat-slide-out { animation-name: slideOutDown; }
        #chat-fab { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        #chat-fab:hover { transform: scale(1.1); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); }
        .chat-message { animation: fadeIn 0.3s ease-in-out; }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9CA3AF; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .tab-btn { transition: all 0.3s ease; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #EF4444; border-bottom-color: #EF4444; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .submit-btn { transition: all 0.3s ease; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .autocomplete-suggestions { border: 1px solid #ddd; max-height: 150px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000; background-color: white; border-radius: 0 0 8px 8px; }
        .autocomplete-suggestion { padding: 10px; cursor: pointer; }
        .autocomplete-suggestion:hover { background-color: #f0f0f0; }
        #donor-map { height: 400px; border-radius: 1rem; margin-top: 1rem; }
        .badge { display: inline-block; padding: 0.25em 0.6em; font-size: 75%; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .mic-btn.listening { animation: pulse 1.5s infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Shortage Alert Banner -->
    <div id="shortage-alert-banner" class="hidden bg-yellow-300 text-yellow-800 p-3 text-center font-semibold"></div>
    
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 left-0 right-0 z-20 border-b border-gray-200">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2"><svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg><span class="text-2xl font-bold text-gray-800">VitaFlow</span></a>
            <nav class="hidden md:flex items-center space-x-8"><a href="#home" class="text-gray-600 hover:text-red-500">Home</a><a href="#donor-directory" class="text-gray-600 hover:text-red-500">Donors</a><a href="#services" class="text-gray-600 hover:text-red-500">Donate/Request</a><a href="#demand-heatmap" class="text-gray-600 hover:text-red-500">Demand Map</a></nav>
            <div id="auth-container"></div>
        </div>
    </header>

    <main class="pt-10">
        <!-- Hero Section -->
        <section id="home" class="py-16 md:py-24"><div class="container mx-auto px-6 text-center"><div class="max-w-3xl mx-auto"><div id="welcome-message" class="hidden text-2xl mb-4 font-semibold"></div><div id="donation-reminder" class="hidden my-4 p-4 bg-green-100 text-green-800 rounded-lg"></div><div id="awareness-tip" class="my-4 p-4 bg-blue-100 text-blue-800 rounded-lg shadow-sm text-left"></div><h1 class="text-4xl md:text-6xl font-bold text-gray-900 mb-4 fade-in">Connect Lifesavers. <span class="text-red-500">Every Drop Counts.</span></h1><p class="text-lg md:text-xl text-gray-600 mb-8 fade-in" style="animation-delay: 0.2s;">Join our community of donors and recipients. Find compatible blood types near you or become a hero by donating blood today.</p><a href="#services" class="bg-red-500 text-white px-8 py-4 rounded-full font-bold text-lg inline-block hover:bg-red-600 shadow-lg hover:shadow-xl submit-btn fade-in" style="animation-delay: 0.4s;">Find a Donor Now</a></div></div></section>

        <!-- Donor Directory & Map -->
        <section id="donor-directory" class="py-20 bg-gray-100"><div class="container mx-auto px-6"><h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Our Lifesavers Directory</h2><p class="text-center text-gray-600 mb-8">Pins on the map represent approximate locations of available donors.</p><div id="donor-map"></div><div id="donor-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mt-12"></div><p id="no-donors-message" class="text-center text-gray-500 hidden mt-8">No donors have registered yet. Be the first!</p></div></section>

        <!-- Services Section: Find/Donate -->
        <section id="services" class="py-20 bg-white"><div class="container mx-auto px-6"><div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-8 border border-gray-100"><div class="flex border-b border-gray-200 mb-6"><button id="request-tab" class="tab-btn flex-1 py-4 text-lg font-semibold text-gray-500 focus:outline-none active">Request Blood</button><button id="donate-tab" class="tab-btn flex-1 py-4 text-lg font-semibold text-gray-500 focus:outline-none">Become a Donor</button></div><div id="request-form" class="form-section active fade-in"><form id="blood-request-form" class="space-y-6"><h2 class="text-2xl font-bold text-center text-gray-800">Find a Blood Donor</h2><div class="grid md:grid-cols-2 gap-6"><div><label for="request-blood-type" class="block text-sm font-medium text-gray-700 mb-1">Blood Type</label><select id="request-blood-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-300 focus:border-red-500"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select></div><div class="relative"><label for="request-location" class="block text-sm font-medium text-gray-700 mb-1">Location (City)</label><input type="text" id="request-location" placeholder="e.g., New York" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-300 focus:border-red-500 autocomplete-input"><div class="autocomplete-suggestions"></div></div></div><div class="pt-2"><button type="submit" class="w-full bg-red-500 text-white py-3 px-6 rounded-lg font-semibold text-lg submit-btn">Find Best Match & Notify</button><button id="emergency-btn" type="button" class="w-full mt-4 bg-red-700 text-white py-3 px-6 rounded-lg font-semibold text-lg submit-btn hover:bg-red-800">Emergency Alert</button></div></form><div id="match-results" class="mt-6"></div></div><div id="donate-form" class="form-section fade-in text-center"><h2 class="text-2xl font-bold text-gray-800">Register as a Donor</h2><p class="text-gray-500">Your donation can save lives. Please use the main "Register" or "My Profile" button in the header to manage your donor status.</p></div></div></div></section>
        
        <!-- Predictive Demand Heatmap -->
        <section id="demand-heatmap" class="py-20 bg-gray-100"><div class="container mx-auto px-6"><h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Blood Demand Heatmap</h2><div id="heatmap-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div></div></section>

    </main>

    <footer class="bg-gray-800 text-white py-12"><div class="container mx-auto px-6 text-center"><p>&copy; 2024 VitaFlow. All rights reserved.</p></div></footer>

    <!-- Modals (Registration, Profile, Emergency) -->
    <div id="register-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 modal-overlay"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md modal-content transform scale-95 opacity-0"><h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Become a VitaFlow Member</h2><form id="registration-form" class="space-y-4"><div><label for="reg-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input type="text" id="reg-name" required class="w-full px-4 py-2 border rounded-lg"></div><div><label for="reg-age" class="block text-sm font-medium text-gray-700 mb-1">Age</label><input type="number" id="reg-age" required class="w-full px-4 py-2 border rounded-lg"></div><div><label for="reg-blood-type" class="block text-sm font-medium text-gray-700 mb-1">Blood Type</label><select id="reg-blood-type" required class="w-full px-4 py-2 border rounded-lg"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select></div><div class="relative"><label for="reg-location" class="block text-sm font-medium text-gray-700 mb-1">Location (City)</label><input type="text" id="reg-location" required class="w-full px-4 py-2 border rounded-lg autocomplete-input"><div class="autocomplete-suggestions"></div></div><div><label for="reg-availability" class="block text-sm font-medium text-gray-700 mb-1">Availability</label><select id="reg-availability" required class="w-full px-4 py-2 border rounded-lg"><option value="available">Available Immediately</option><option value="on-notice">Available on Notice</option></select></div><button type="submit" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg font-semibold text-lg submit-btn hover:bg-blue-600">Register</button></form><button id="close-register-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div></div>
    <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 modal-overlay"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg modal-content transform scale-95 opacity-0"><h2 class="text-2xl font-bold text-center text-gray-800 mb-6">My Donor Profile</h2><div id="profile-content"></div><div class="mt-6 flex justify-center"><button id="get-health-tip-btn" class="bg-green-500 text-white px-5 py-2 rounded-full font-semibold">Get AI Health Tip</button></div><button id="close-profile-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div></div>
    <div id="emergency-alert-modal" class="hidden fixed inset-0 bg-red-900 bg-opacity-90 z-50 flex items-center justify-center p-4 text-white text-center"><div class="max-w-xl animate-pulse"><h1 class="text-5xl font-bold">URGENT BLOOD REQUEST!</h1><p class="text-xl mt-4" id="emergency-details"></p><div class="mt-8"><button id="get-emergency-guidance-btn" class="bg-white text-red-700 px-6 py-3 rounded-full font-bold">Get AI Emergency Guidance</button><button id="close-emergency-modal-btn" class="ml-4 border-2 border-white px-6 py-3 rounded-full font-bold">Dismiss</button></div></div></div>

    <!-- AI Chatbot -->
    <button id="chat-fab" class="fixed bottom-6 right-6 bg-blue-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center focus:outline-none z-30"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></button>
    <div id="ai-chat-container" class="hidden fixed bottom-24 right-6 w-full max-w-sm h-[70vh] max-h-[600px] z-30"><div class="bg-white w-full h-full rounded-2xl shadow-2xl flex flex-col border"><div class="p-4 border-b bg-blue-500 text-white rounded-t-2xl flex justify-between items-center"><div class="flex flex-col"><h3 class="text-lg font-semibold">VitaFlow AI Assistant</h3><select id="language-select" class="bg-blue-600 text-white text-sm rounded mt-1 p-1"><option value="en">English</option><option value="es">Español</option><option value="fr">Français</option><option value="hi">हिन्दी</option></select></div><button id="close-chat" class="text-white hover:opacity-80 focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4"></div><div id="typing-indicator" class="hidden p-4"><div class="flex items-center space-x-1"><div class="bg-gray-200 p-3 rounded-lg"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div></div><div class="p-4 border-t"><form id="chat-form" class="flex items-center space-x-2"><button type="button" id="mic-btn" class="p-2 text-gray-500 hover:text-blue-500"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H7v1h6v-1h-2v-2.07z" clip-rule="evenodd" /></svg></button><input id="chat-input" type="text" placeholder="Ask or speak..." autocomplete="off" class="w-full px-4 py-2 border rounded-full focus:ring-2 focus:ring-blue-300"><button type="submit" class="bg-blue-500 text-white p-2.5 rounded-full hover:bg-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></form></div></div></div>

    <script type="module">
        // This script is now a module to support modern features.
        document.addEventListener('DOMContentLoaded', () => {
            // --- Initialize EmailJS ---
            (function(){
                // IMPORTANT: Replace with your EmailJS Public Key
                emailjs.init({ publicKey: "b48uSOsNuns52FAhU" });
            })();

            // --- Elements ---
            const authContainer = document.getElementById('auth-container');
            const welcomeMessage = document.getElementById('welcome-message');
            const donorListContainer = document.getElementById('donor-list');
            const noDonorsMessage = document.getElementById('no-donors-message');
            const bloodRequestForm = document.getElementById('blood-request-form');
            const emergencyBtn = document.getElementById('emergency-btn');
            const awarenessTipEl = document.getElementById('awareness-tip');
            const heatmapContainer = document.getElementById('heatmap-container');
            const shortageBanner = document.getElementById('shortage-alert-banner');
            const donationReminderEl = document.getElementById('donation-reminder');
            const matchResultsEl = document.getElementById('match-results');

            // --- Modal Elements ---
            const registerModal = document.getElementById('register-modal');
            const profileModal = document.getElementById('profile-modal');
            const emergencyModal = document.getElementById('emergency-alert-modal');

            // --- Local Storage Keys ---
            const USER_KEY = 'vitaflow_user_v2';
            const DONORS_KEY = 'vitaflow_donors_v2';

            // --- Mock Data ---
            const locations = { "New York": [40.7128, -74.0060], "Los Angeles": [34.0522, -118.2437], "Chicago": [41.8781, -87.6298], "Houston": [29.7604, -95.3698], "Phoenix": [33.4484, -112.0740], "Mumbai": [19.0760, 72.8777], "Delhi": [28.7041, 77.1025], "Bangalore": [12.9716, 77.5946]};
            const locationNames = Object.keys(locations);

            // --- App State ---
            let currentUser = JSON.parse(localStorage.getItem(USER_KEY));
            let allDonors = JSON.parse(localStorage.getItem(DONORS_KEY)) || [];
            let donorMap;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            // --- Initialization ---
            function initialize() {
                updateAuthStateUI();
                renderDonors();
                initializeMap();
                renderHeatmap();
                checkShortages();
                fetchAwarenessTip();
                checkDonationEligibility();
                setupEventListeners();
                if (SpeechRecognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    recognition.onresult = (event) => {
                        const speechResult = event.results[0][0].transcript;
                        document.getElementById('chat-input').value = speechResult;
                        document.getElementById('chat-form').requestSubmit();
                    };
                    recognition.onspeechend = () => { recognition.stop(); document.getElementById('mic-btn').classList.remove('listening', 'text-red-500'); };
                    recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); document.getElementById('mic-btn').classList.remove('listening', 'text-red-500'); };
                }
            }

            function setupEventListeners() {
                document.body.addEventListener('click', (e) => {
                    if (e.target.closest('#register-btn')) toggleModal('register', true);
                    if (e.target.closest('#profile-btn')) toggleModal('profile', true);
                    if (e.target.closest('#logout-btn')) handleLogout();
                    if (e.target.closest('#close-register-modal-btn') || e.target === registerModal) toggleModal('register', false);
                    if (e.target.closest('#close-profile-modal-btn') || e.target === profileModal) toggleModal('profile', false);
                });
                document.getElementById('registration-form').addEventListener('submit', handleRegistration);
                document.querySelectorAll('.autocomplete-input').forEach(input => {
                    input.addEventListener('input', handleAutocomplete);
                    input.addEventListener('blur', () => setTimeout(() => { input.nextElementSibling.innerHTML = ''; }, 200));
                });
                bloodRequestForm.addEventListener('submit', (e) => { e.preventDefault(); handleSmartMatchAndNotify(); });
                emergencyBtn.addEventListener('click', handleEmergency);
                document.getElementById('close-emergency-modal-btn').addEventListener('click', () => emergencyModal.classList.add('hidden'));
                document.getElementById('get-emergency-guidance-btn').addEventListener('click', () => {
                    toggleChat(true);
                    const prompt = "I have an urgent medical emergency and need blood. What are the immediate steps I should take while I wait for medical services? Give me safe, clear, step-by-step advice.";
                    document.getElementById('chat-input').value = prompt;
                    document.getElementById('chat-form').requestSubmit();
                });
                document.getElementById('get-health-tip-btn')?.addEventListener('click', getAIHealthTip);
                if (SpeechRecognition) document.getElementById('mic-btn').addEventListener('click', toggleVoiceInput);
            }
            
            // --- UI & State Management ---
            function updateAuthStateUI() {
                authContainer.innerHTML = '';
                if (currentUser) {
                    welcomeMessage.textContent = `Welcome back, ${currentUser.name}!`;
                    welcomeMessage.classList.remove('hidden');
                    authContainer.innerHTML = `
                        <button id="profile-btn" class="bg-blue-500 text-white px-5 py-2 rounded-full font-semibold">My Profile</button>
                        <button id="logout-btn" class="ml-2 bg-gray-500 text-white px-5 py-2 rounded-full font-semibold">Logout</button>
                    `;
                } else {
                    welcomeMessage.classList.add('hidden');
                    authContainer.innerHTML = `<button id="register-btn" class="bg-red-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-red-600">Register</button>`;
                }
            }
            
            function toggleModal(modalName, show) {
                const modal = document.getElementById(`${modalName}-modal`);
                const content = modal.querySelector('.modal-content');
                if (show) {
                    if (modalName === 'profile') renderProfile();
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        content.classList.remove('scale-95', 'opacity-0');
                    }, 10);
                } else {
                    modal.classList.add('opacity-0');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }
            
            // --- Handlers ---
            function handleRegistration(e) {
                e.preventDefault();
                const newUser = {
                    id: `user_${Date.now()}`,
                    name: document.getElementById('reg-name').value,
                    age: document.getElementById('reg-age').value,
                    bloodType: document.getElementById('reg-blood-type').value,
                    location: document.getElementById('reg-location').value,
                    availability: document.getElementById('reg-availability').value,
                    lastDonationDate: new Date().toISOString(),
                    donationHistory: [{ date: new Date().toISOString(), location: 'VitaFlow Registration' }]
                };
                localStorage.setItem(USER_KEY, JSON.stringify(newUser));
                const existingDonor = allDonors.find(d => d.id === newUser.id);
                if(!existingDonor) { allDonors.push(newUser); }
                localStorage.setItem(DONORS_KEY, JSON.stringify(allDonors));
                currentUser = newUser;
                updateAuthStateUI();
                renderDonors();
                updateMap();
                toggleModal('register', false);
            }

            function handleLogout() {
                localStorage.removeItem(USER_KEY);
                currentUser = null;
                updateAuthStateUI();
                window.location.reload();
            }

            function handleAutocomplete(e) {
                const input = e.target, suggestionsContainer = input.nextElementSibling, value = input.value.toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (!value) return;
                const filtered = locationNames.filter(loc => loc.toLowerCase().startsWith(value));
                filtered.forEach(loc => {
                    const div = document.createElement('div');
                    div.textContent = loc;
                    div.className = 'autocomplete-suggestion';
                    div.onclick = () => { input.value = loc; suggestionsContainer.innerHTML = ''; };
                    suggestionsContainer.appendChild(div);
                });
            }
            
            function handleSmartMatchAndNotify() {
                const type = document.getElementById('request-blood-type').value;
                const loc = document.getElementById('request-location').value;

                // 1. Find the best match (existing logic)
                handleSmartMatch(type, loc);
                
                // 2. Send the email notification
                sendEmailNotification(type, loc);
            }

            function handleSmartMatch(type, loc) {
                const now = new Date();
                const compatibleDonors = allDonors.filter(donor => {
                    const isTypeMatch = donor.bloodType === type;
                    const isLocationMatch = donor.location === loc;
                    const lastDonation = new Date(donor.lastDonationDate);
                    const daysSinceDonation = (now - lastDonation) / (1000 * 60 * 60 * 24);
                    return isTypeMatch && isLocationMatch && daysSinceDonation >= 56;
                });
                compatibleDonors.sort((a, b) => {
                    if (a.availability === 'available' && b.availability !== 'available') return -1;
                    if (b.availability === 'available' && a.availability !== 'available') return 1;
                    return new Date(b.lastDonationDate) - new Date(a.lastDonationDate);
                });
                
                matchResultsEl.innerHTML = '';
                if (compatibleDonors.length > 0) {
                    const bestMatch = compatibleDonors[0];
                    matchResultsEl.innerHTML = `<div class="p-4 bg-green-100 text-green-800 rounded-lg"><strong>Best Match Found:</strong> ${bestMatch.name} in ${bestMatch.location}.<br><small>Status: ${bestMatch.availability}. Eligible since ${new Date(bestMatch.lastDonationDate).toLocaleDateString()}.</small></div>`;
                } else {
                    matchResultsEl.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg"><strong>No immediate matches found.</strong> An alert has been sent.</div>`;
                }
            }

            function sendEmailNotification(bloodType, location) {
                // IMPORTANT: Replace with your EmailJS Service ID and Template ID
                const serviceID = 'service_nl5rrgl';
                const templateID = 'template_fkbm3q2';

                const templateParams = {
                    blood_type: bloodType,
                    location: location,
                    to_email: 'adhithyankjadhi1234@gmail.com'
                };

                emailjs.send(serviceID, templateID, templateParams)
                    .then((response) => {
                       console.log('SUCCESS!', response.status, response.text);
                       matchResultsEl.innerHTML += `<p class="text-sm text-green-600 mt-2">Notification email sent successfully.</p>`;
                    }, (error) => {
                       console.log('FAILED...', error);
                       matchResultsEl.innerHTML += `<p class="text-sm text-red-600 mt-2">Failed to send notification email. Please check EmailJS configuration.</p>`;
                    });
            }

            function handleEmergency() {
                const type = document.getElementById('request-blood-type').value;
                const loc = document.getElementById('request-location').value;
                document.getElementById('emergency-details').textContent = `An urgent request for ${type} blood has been issued in ${loc}. Nearby donors are being notified.`;
                emergencyModal.classList.remove('hidden');
            }

            // --- Feature Rendering ---
            function renderDonors() {
                donorListContainer.innerHTML = '';
                if (allDonors.length === 0) {
                    noDonorsMessage.classList.remove('hidden');
                } else {
                    noDonorsMessage.classList.add('hidden');
                    allDonors.forEach(donor => {
                        donorListContainer.insertAdjacentHTML('beforeend', `
                            <div class="bg-white p-6 rounded-xl shadow-md border fade-in"><div class="flex items-center space-x-4">
                                <div class="bg-red-100 text-red-500 font-bold text-2xl rounded-full w-16 h-16 flex items-center justify-center">${donor.bloodType}</div>
                                <div><h3 class="text-xl font-bold">${donor.name}</h3><p class="text-gray-500">${donor.location}</p></div>
                            </div></div>`);
                    });
                }
            }

            function initializeMap() {
                if (document.getElementById('donor-map')._leaflet_id) return;
                donorMap = L.map('donor-map').setView([20.5937, 78.9629], 5); // Centered on India
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(donorMap);
                updateMap();
            }

            function updateMap() {
                if (!donorMap) return;
                donorMap.eachLayer(layer => { if (layer instanceof L.Marker) donorMap.removeLayer(layer); });
                allDonors.forEach(donor => {
                    const coords = locations[donor.location];
                    if (coords) {
                        L.marker(coords).addTo(donorMap)
                            .bindPopup(`<b>${donor.name}</b><br>Blood Type: ${donor.bloodType}<br>Status: ${donor.availability}`);
                    }
                });
            }

            function renderProfile() {
                const profileContent = document.getElementById('profile-content');
                if (!currentUser) return;
                const donationCount = currentUser.donationHistory.length;
                let badges = '';
                if (donationCount >= 1) badges += `<span class="badge bg-blue-100 text-blue-800">First Donation</span> `;
                if (donationCount >= 5) badges += `<span class="badge bg-green-100 text-green-800">5-Time Donor</span>`;
                
                profileContent.innerHTML = `
                    <p><strong>Name:</strong> ${currentUser.name}</p>
                    <p><strong>Age:</strong> ${currentUser.age}</p>
                    <p><strong>Blood Type:</strong> ${currentUser.bloodType}</p>
                    <p><strong>Location:</strong> ${currentUser.location}</p>
                    <p><strong>Total Donations:</strong> ${donationCount}</p>
                    <div class="mt-4"><strong>Badges:</strong> ${badges || 'None yet!'}</div>
                    <h4 class="font-bold mt-4">Donation History:</h4>
                    <ul class="list-disc pl-5 max-h-32 overflow-y-auto">${currentUser.donationHistory.map(d => `<li>${new Date(d.date).toLocaleDateString()} - ${d.location}</li>`).join('')}</ul>
                `;
            }

            function renderHeatmap() {
                heatmapContainer.innerHTML = '';
                locationNames.forEach(loc => {
                    const demandLevels = ['Low', 'Medium', 'High'];
                    const colors = {'Low': 'bg-green-500', 'Medium': 'bg-yellow-500', 'High': 'bg-red-500'};
                    const demand = demandLevels[Math.floor(Math.random() * 3)];
                    heatmapContainer.insertAdjacentHTML('beforeend', `<div class="p-4 rounded-lg text-white text-center shadow ${colors[demand]}"><strong>${loc}</strong><br>${demand} Demand</div>`);
                });
            }

            function checkShortages() {
                if (currentUser?.location) {
                    const userLocationDemand = document.querySelector(`#heatmap-container > div:nth-child(${locationNames.indexOf(currentUser.location) + 1})`);
                    if (userLocationDemand && userLocationDemand.textContent.includes('High')) {
                        shortageBanner.textContent = `High demand for blood currently reported in your area: ${currentUser.location}. Your donation could make a huge difference!`;
                        shortageBanner.classList.remove('hidden');
                    }
                }
            }

            async function fetchAwarenessTip() {
                const prompt = `Give me a single, short, encouraging, and informative tip about blood donation.`;
                awarenessTipEl.innerHTML = `<strong>AI Tip of the Day:</strong> Loading...`;
                try {
                    const tip = await callGeminiAPI(prompt, true);
                    awarenessTipEl.innerHTML = `<strong>AI Tip of the Day:</strong> ${tip}`;
                } catch(e) { awarenessTipEl.innerHTML = `<strong>AI Tip of the Day:</strong> Always stay hydrated before donating blood.`; }
            }

            function checkDonationEligibility() {
                if (currentUser) {
                    const lastDonation = new Date(currentUser.lastDonationDate);
                    const nextEligibleDate = new Date(lastDonation.setDate(lastDonation.getDate() + 56));
                    if (new Date() > nextEligibleDate) {
                        donationReminderEl.textContent = `You are eligible to donate blood again! Your last donation was on ${new Date(currentUser.lastDonationDate).toLocaleDateString()}.`;
                        donationReminderEl.classList.remove('hidden');
                    }
                }
            }
            
            async function getAIHealthTip() {
                 if (!currentUser) return;
                 const prompt = `I am a blood donor. My blood type is ${currentUser.bloodType} and I last donated on ${new Date(currentUser.lastDonationDate).toLocaleDateString()}. Give me one personalized health tip.`;
                 toggleChat(true);
                 document.getElementById('chat-input').value = prompt;
                 document.getElementById('chat-form').requestSubmit();
                 toggleModal('profile', false);
            }

            // --- Voice Chat ---
            function toggleVoiceInput() {
                if (!recognition) return;
                const micBtn = document.getElementById('mic-btn');
                if (micBtn.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    recognition.start();
                    micBtn.classList.add('listening', 'text-red-500');
                }
            }

            function speakText(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = document.getElementById('language-select').value;
                    speechSynthesis.speak(utterance);
                }
            }

            // --- Chatbot & Gemini API Logic ---
            const chatFab = document.getElementById('chat-fab'), chatContainer = document.getElementById('ai-chat-container'), closeChatBtn = document.getElementById('close-chat'), chatForm = document.getElementById('chat-form'), chatInput = document.getElementById('chat-input'), chatMessages = document.getElementById('chat-messages'), typingIndicator = document.getElementById('typing-indicator'), langSelect = document.getElementById('language-select');
            
            const toggleChat = (show) => {
                if (show) { chatContainer.classList.remove('hidden', 'chat-slide-out'); chatContainer.classList.add('chat-slide-in'); }
                else { chatContainer.classList.remove('chat-slide-in'); chatContainer.classList.add('chat-slide-out'); setTimeout(() => chatContainer.classList.add('hidden'), 400); }
            };
            
            chatFab.addEventListener('click', () => toggleChat(true));
            closeChatBtn.addEventListener('click', () => toggleChat(false));
            
            const apiKey = "AIzaSyA079gImrV5a_xf-cvYHTbGsjM_PdU7xXo";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `You are VitaFlow Assistant, an expert AI for a blood donation app. Your role is to:
1.  Answer any user questions about blood donation (eligibility, process, health tips).
2.  Guide users on how to use the app's features.
3.  Provide safe, clear advice, but ALWAYS preface medical or emergency advice with "This is not a substitute for professional medical advice. Please contact emergency services (like 112 in India) or a healthcare provider immediately."
4.  Be encouraging, clear, and concise. Keep answers short for chat.
5.  If the user asks a question in a different language (specified in the prompt), you MUST respond fully in that language.`;

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                appendMessage(userMessage, 'user');
                chatInput.value = '';
                typingIndicator.classList.remove('hidden');

                if (apiKey === "YOUR_GEMINI_API_KEY") { appendMessage("The AI assistant is not configured. Please add the API key.", 'ai'); typingIndicator.classList.add('hidden'); return; }

                try {
                    const aiResponse = await callGeminiAPI(userMessage);
                    appendMessage(aiResponse, 'ai');
                } catch (error) { appendMessage("I'm having trouble connecting. Please try again.", 'ai'); } 
                finally { typingIndicator.classList.add('hidden'); }
            });

            function appendMessage(text, sender) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-message flex items-end space-x-2 ${sender === 'user' ? 'justify-end' : ''}`;
                const bubble = document.createElement('div');
                bubble.className = `p-3 rounded-lg max-w-xs ${sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}`;
                bubble.textContent = text;
                
                if (sender === 'ai') {
                    const speakerBtn = document.createElement('button');
                    speakerBtn.className = 'text-gray-400 hover:text-gray-600';
                    speakerBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 7a1 1 0 00-2 0v6a1 1 0 102 0V7zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V7zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V7z"></path></svg>`;
                    speakerBtn.onclick = () => speakText(text);
                    wrapper.appendChild(bubble);
                    wrapper.appendChild(speakerBtn);
                } else {
                    wrapper.appendChild(bubble);
                }
                chatMessages.appendChild(wrapper);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function callGeminiAPI(userQuery, isInternal = false) {
                let processedQuery = userQuery;
                const selectedLang = langSelect.value;
                if (selectedLang !== 'en' && !isInternal) {
                    processedQuery = `Please answer the following question in the language with code '${selectedLang}': ${userQuery}`;
                }
                const payload = { contents: [{ parts: [{ text: processedQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) return candidate.content.parts[0].text;
                else throw new Error("Invalid API response.");
            }

            // --- Initial Load ---
            initialize();
        });
    </script>
</body>
</html>

